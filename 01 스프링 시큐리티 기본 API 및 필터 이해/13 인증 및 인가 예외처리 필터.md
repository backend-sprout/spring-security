# ExceptionTranslationFilter 

ExceptionTranslationFilter ëŠ” í¬ê²Œ ë‘ê°€ì§€ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤.   

1. AuthenticationException
2. AccessDeniedException

**AuthenticationException**  
* **ì¸ì¦ ì˜ˆì™¸ ì²˜ë¦¬**     
* AuthenticationEntryPoint í˜¸ì¶œ 
    * ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™, 401 ì˜¤ë¥˜ ì½”ë“œ ì „ë‹¬ ë“±   
* ì¸ì¦ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸°ì „ì˜ ìš”ì²­ ì •ë³´ë¥¼ ì €ì¥   
    * RequestCache êµ¬í˜„ì²´ : ì‚¬ìš©ìì˜ ì´ì „ ìš”ì²­ ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ê³  ì´ë¥¼ êº¼ë‚´ì˜¤ëŠ” ìºì‹œ ë§¤ì»¤ë‹ˆì¦˜    
    * SavedRequest êµ¬í˜„ì²´ : ì‚¬ìš©ìê°€ ìš”ì²­í–ˆë˜ request íŒŒë¼ë¯¸í„° ê°’ë“¤, ê·¸ ë‹¹ì‹œì˜ í—¤ë”ê°’ë“¤ ë“±ì´ ì €ì¥ëœë‹¤.        
   
ì¦‰, ìš”ì²­ì‹œ ì¸ì¦ë˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ ìš”ì²­í˜ì´ì§€ë¡œ ì´ë™ì„ ì‹œí‚¨ë‹¤.            
ì´ë™ ì‹œí‚¤ê¸° ì „ì—, ì‚¬ìš©ìì˜ ìš”ì²­ ì •ë³´ë¥¼ ìºì‹œì— ì €ì¥ì„í•œë‹¤.        
ì—¬ê¸°ì„œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ìºì‹œì—ì„œ ì´ì „ ì‚¬ìš©ì ìš”ì²­ ì •ë³´ë¥¼ êº¼ë‚´ì„œ ìš”ì²­ íë¦„ì„ ì´ì–´ê°ˆ ìˆ˜ ìˆë„ë¡í•œë‹¤.   
  
**AccessDeniedException**       
* **ì¸ê°€ ì˜ˆì™¸ ì²˜ë¦¬**        
* AccessDeniedHandlerì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬í•˜ë„ë¡ ì œê³µí•œë‹¤.    
  
**ê·¸ë ‡ë‹¤ë©´ ìœ„ì™€ ê°™ì€ ì˜ˆì™¸ëŠ” ì–´ëŠ í´ë˜ìŠ¤ì—ì„œ ë°œìƒì‹œí‚¤ëŠ” ê²ƒì¼ê¹ŒğŸ¤”?**               
ìœ„ ë‘ ì—ì™¸ëŠ” FilterSecurityInterceptor ì—ì„œ ë°œìƒí•œë‹¤.(throw)               
í•„í„°ì˜ í•œ ì¢…ë¥˜ì´ë©° SpringSecurity ê°€ ê´€ë¦¬í•˜ëŠ” í•„í„°ì¤‘ì—ì„œë„ ë§¨ ë§ˆì§€ë§‰ì— ìœ„ì¹˜í•´ìˆë‹¤.       

ê·¸ë¦¬ê³  ì´ í•„í„°ì˜ ë°”ë¡œ ì•ì— ì¡´ì¬í•˜ëŠ” í•„í„°ëŠ” ì´ë“¤ì„ ì˜ˆì™¸ì²˜ë¦¬í•˜ëŠ” `ExceptionTranslationFilter`ì˜€ë˜ ê²ƒì´ë‹¤.   

```java
		try {
			chain.doFilter(request, response);
		} catch (Exception ex) {
			... //ìƒëµ 
		} 
```
ì¦‰, ìœ„ì™€ ê°™ì´ try-catchë¡œ ê°ì‹¸ì„œ `FilterSecurityInterceptor`í•„í„°ë¥¼ í˜¸ì¶œí•˜ê³  ìˆë‹¤.  
 
ì •ë¦¬í•˜ìë©´,    
FilterSecurityInterceptor ì—ì„œ ì•ˆì¦/ì¸ê°€ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´      
ExceptionTranslationFilter ì—ì„œ ì¸ì¦/ì¸ê°€ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” êµ¬ì¡°ì´ë‹¤.      

# ì˜ˆì™¸ì²˜ë¦¬ í•„í„° íë¦„ 

![image](https://user-images.githubusercontent.com/50267433/150917317-2398d097-87be-4b50-9bd3-de24ec8489ab.png)
 
1. ì¸ì¦ì„ ë°›ì§€ ì•Šê³  `/user`ì— ì ‘ê·¼í•œë‹¤ê³  ê°€ì •í•œë‹¤.    
2. FilterSecurityInterceptor ì—ì„œ ìƒí™©ì— ë”°ë¼ ì˜ˆì™¸ë¥¼ ë°œìƒí•œë‹¤.    
    * ë³´ë‹¤ ìì„¸íˆ ì„¤ëª…í•˜ë©´ `ìµëª… ì‚¬ìš©ì ê¸°ëŠ¥`ì´ í™œì„±í™” ë˜ì–´ìˆìœ¼ë¯€ë¡œ `ì¸ì¦` ëŒ€ì‹  `ì¸ê°€` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
      ê·¸ëŸ¬ë‚˜ ìµëª… ì‚¬ìš©ìì¸ì§€ ê²€ì¦í•˜ê³  ë‹¤ì‹œ ì¸ì¦ ì˜ˆì™¸ì²˜ë¦¬ êµ¬ë¬¸ìœ¼ë¡œ ë„˜ê²¨ì£¼ê¸´í•œë‹¤.    
      RememberMe ì¸ì¦ì˜ ê²½ìš°ë„  `ì¸ì¦` ëŒ€ì‹  `ì¸ê°€` ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ë§Œ   
      RememberMe ì¸ì§€ ê²€ì¦í•˜ê³  ë‹¤ì‹œ ì¸ì¦ ì˜ˆì™¸ì²˜ë¦¬ êµ¬ë¬¸ìœ¼ë¡œ ë„˜ê²¨ì¤€ë‹¤.    
    * í˜„ì¬ëŠ” íë¦„ì˜ ì´í•´ë¥¼ ì‰½ê²Œí•˜ê¸° ìœ„í•´ ì¸ì¦ ì˜ˆì™¸ê°€ ë°œìƒí–ˆë‹¤ê³  ê°€ì •í•œë‹¤.   
3. ExceptionTranslationFilterì€ ì´ë¥¼ catchí•´ì„œ catch êµ¬ë¬¸ì„ ì‹¤í–‰ì‹œí‚¨ë‹¤.   
4. catch êµ¬ë¬¸ì—ì„œëŠ” `handleSpringSecurityException()`ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.  
5. `handleSpringSecurityException()` ëŠ” ì¸ì¦/ì¸ê°€ ì˜ˆì™¸ë¥¼ êµ¬ë¶„í•˜ê³  ì´ì—ë”°ë¼ ì•Œë§ëŠ” ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.   
    * ì¸ì¦ì´ì—ˆì„ ê²½ìš° 
        * EntryPointì„ í˜¸ì¶œí•˜ì—¬ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ì„ ì‹œí‚¨ë‹¤.   
        * ì´ ë•Œ HttpSessionRequestCacheì—ì„œ ìºì‹± ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.  
        * ì‚¬ìš©ì ìš”ì²­ ë°ì´í„°ë¥¼ DefaultSavedRequestë¡œ ë§Œë“¤ê³  sessionì— ì €ì¥ì„ í•œë‹¤. 
        * ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ êº¼ë‚´ì„œ ì‘ì—…ì„ ì´ì–´ê°€ë„ë¡ í•œë‹¤.   
    * ì¸ê°€ì˜€ì„ ê²½ìš°
        * AccessDeinedHandlerë¥¼ í˜¸ì¶œí•˜ì—¬ íŠ¹ì • í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¨ë‹¤.   
        * ErrorResponseë¥¼ ë‚´ë ¤ì£¼ê¸°ë„í•œë‹¤.  

# ExceptionTranslationFilter

```java
http.exceptionHandling() // ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì´ ë™ì‘í•¨ 
    .authenticationEntryPoint(new CustomAuthenticationEntryPoint()) // ì¸ì¦ ì‹¤íŒ¨ì‹œ ì²˜ë¦¬ 
    .accessDeniedHandler(new CustomAccessDeniedHandler()); 	  // ì¸ê°€ ì‹¤íŒ¨ì‹œ ì²˜ë¦¬ 
```

`http.exceptionHandling()`ëŠ” ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì„ ë™ì‘ì‹œí‚¤ëŠ” ë©”ì„œë“œì´ë‹¤.       
ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì •ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ì„ ì–¸ì„ í•  í•„ìš”ëŠ” ì—†ë‹¤.     
ê·¸ëŸ¬ë‚˜ CustomEntryPointë‚˜ CustomAccessDeinedê°€ í•„ìš”í•  ê²½ìš° ì„ ì–¸í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.   

# ì‹¤ìŠµ 

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(final AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication().withUser("user").password("{noop}1111").roles("USER");
        auth.inMemoryAuthentication().withUser("sys").password("{noop}1111").roles("SYS", "USER");
        auth.inMemoryAuthentication().withUser("admin").password("{noop}1111").roles("ADMIN", "SYS", "USER");
    }

    @Override
    protected void configure(final HttpSecurity http) throws Exception {

        http
                .authorizeRequests()
		.antMatchers("/login").permitAll()
                .antMatchers("/user").hasRole("USER")
                .antMatchers("/admin/pay").hasRole("ADMIN")
                .antMatchers("/admin/**").access("hasRole('ADMIN') or hasRole('SYS')")
                .anyRequest().authenticated();

        http
                .formLogin()
                .successHandler(new AuthenticationSuccessHandler() {
                    @Override
                    public void onAuthenticationSuccess(final HttpServletRequest request, final HttpServletResponse response, 
		                                        final Authentication authentication) throws IOException, ServletException {
                        final RequestCache requestCache = new HttpSessionRequestCache();
                        final SavedRequest savedRequest = requestCache.getRequest(request, response);
                        final String redirectUrl = savedRequest.getRedirectUrl();
                        response.sendRedirect(redirectUrl);
                    }
                });

        http.exceptionHandling()
                .authenticationEntryPoint(new AuthenticationEntryPoint() {
                    @Override
                    public void commence(final HttpServletRequest request, final HttpServletResponse response, 
		                         final AuthenticationException authException) throws IOException, ServletException {
                        response.sendRedirect("/login");
                    }
                })
                .accessDeniedHandler(new AccessDeniedHandler() {
                    @Override
                    public void handle(final HttpServletRequest request, final HttpServletResponse response, 
		                       final AccessDeniedException accessDeniedException) throws IOException, ServletException {
                        response.sendRedirect("/denied");
                    }
                });
    }
}
```
ë‹¨, ìœ„ì™€ ê°™ì´ ì„¤ì •í–ˆì„ ê²½ìš° SpringSecurity ì—ì„œ ì„¤ì •í•œ í˜ì´ì§€ê°€ ì•„ë‹Œ ìš°ë¦¬ê°€ ì„¤ì •í•œ `/login` í˜ì´ì§€ë¡œ ì´ë™ì„ í•œë‹¤.     
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, ì»¨í‹€ë¡¤ëŸ¬ì—ì„œë„ `/login`ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” í•¸ë“¤ëŸ¬ë¥¼ ì‘ì„±í•´ì£¼ì     
ë˜í•œ ì´ì „ì— ì¸ê°€ ì‘ì—…ë„ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì´ë¥¼ í•´ê²°í•˜ëŠ” ì„¤ì •ë„ ë„£ì–´ì¤˜ì•¼í•œë‹¤.  

```java

```



